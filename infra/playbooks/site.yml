---
# site.yml - Main Ansible playbook for application deployment
# Uses roles for modular and reusable configuration management

- name: Install System Dependencies
  hosts: all_instances
  become: yes
  gather_facts: yes

  roles:
    - dependencies

  tags:
    - dependencies
    - setup

- name: Deploy Applications
  hosts: all_instances
  become: yes
  gather_facts: no

  pre_tasks:
    - name: Verify server is accessible
      wait_for_connection:
        delay: 10
        timeout: 300
      tags:
        - deploy
        - always

  roles:
    - deploy

  post_tasks:
    - name: Display deployment status
      debug:
        msg: |
          ✓ Deployment completed for {{ inventory_hostname }}
          ✓ Application deployed to: {{ app_directory }}
          ✓ Environment: {{ environment }}
      tags:
        - deploy
        - always

  tags:
    - deploy
    - application

- name: Configure Monitoring
  hosts: all_instances
  become: yes
  gather_facts: no

  tasks:
    - name: Install CloudWatch agent
      shell: |
        wget https://s3.amazonaws.com/amazoncloudwatch-agent/amazon_linux/amd64/latest/amazon-cloudwatch-agent.rpm
        rpm -U ./amazon-cloudwatch-agent.rpm
      ignore_errors: yes
      tags:
        - monitoring
        - optional

    - name: Create CloudWatch config
      copy:
        content: |
          {
            "metrics": {
              "namespace": "{{ project | default('DevOps-Stage-6') }}",
              "metrics_collected": {
                "cpu": {
                  "measurement": [
                    {
                      "name": "cpu_usage_idle",
                      "rename": "CPU_IDLE",
                      "unit": "Percent"
                    }
                  ],
                  "totalcpu": false
                },
                "disk": {
                  "measurement": [
                    {
                      "name": "used_percent",
                      "rename": "DISK_USED",
                      "unit": "Percent"
                    }
                  ],
                  "metrics_collection_interval": 60,
                  "resources": [
                    "/"
                  ]
                },
                "mem": {
                  "measurement": [
                    {
                      "name": "mem_used_percent",
                      "rename": "MEM_USED",
                      "unit": "Percent"
                    }
                  ]
                }
              }
            }
          }
        dest: /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json
      become: yes
      ignore_errors: yes
      tags:
        - monitoring
        - optional

  tags:
    - monitoring

- name: Health Check
  hosts: localhost
  gather_facts: no

  tasks:
    - name: Wait for services to be ready
      pause:
        seconds: 30
      tags:
        - health-check
        - always

    - name: Check application health
      uri:
        url: "http://{{ alb_endpoint | default('localhost') }}/health"
        method: GET
        status_code: 200
      retries: 5
      delay: 10
      ignore_errors: yes
      register: health_check
      tags:
        - health-check
        - always

    - name: Display health check result
      debug:
        msg: "Health check status: {{ health_check.status | default('failed') }}"
      tags:
        - health-check
        - always
