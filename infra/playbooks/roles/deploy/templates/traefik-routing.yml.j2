# roles/deploy/templates/traefik-routing.yml.j2
# Traefik Dynamic Routing Configuration

http:
  services:
    auth-api:
      loadBalancer:
        servers:
          - url: http://auth-api:{{ auth_api_port | default('3001') }}
        passHostHeader: true

    todos-api:
      loadBalancer:
        servers:
          - url: http://todos-api:{{ todos_api_port | default('3002') }}
        passHostHeader: true

    users-api:
      loadBalancer:
        servers:
          - url: http://users-api:{{ users_api_port | default('8080') }}
        passHostHeader: true

    frontend:
      loadBalancer:
        servers:
          - url: http://frontend:80
        passHostHeader: true

  routers:
    auth-api-http:
      entryPoints:
        - web
      rule: Host(`{{ domain | default('localhost') }}`) && PathPrefix(`/auth`)
      service: auth-api
      middlewares:
        - auth-headers

    auth-api-https:
      entryPoints:
        - websecure
      rule: Host(`{{ domain | default('localhost') }}`) && PathPrefix(`/auth`)
      service: auth-api
      middlewares:
        - auth-headers
      tls:
        certResolver: letsencrypt

    todos-api-http:
      entryPoints:
        - web
      rule: Host(`{{ domain | default('localhost') }}`) && PathPrefix(`/todos`)
      service: todos-api

    todos-api-https:
      entryPoints:
        - websecure
      rule: Host(`{{ domain | default('localhost') }}`) && PathPrefix(`/todos`)
      service: todos-api
      tls:
        certResolver: letsencrypt

    users-api-http:
      entryPoints:
        - web
      rule: Host(`{{ domain | default('localhost') }}`) && PathPrefix(`/users`)
      service: users-api

    users-api-https:
      entryPoints:
        - websecure
      rule: Host(`{{ domain | default('localhost') }}`) && PathPrefix(`/users`)
      service: users-api
      tls:
        certResolver: letsencrypt

    frontend-http:
      entryPoints:
        - web
      rule: Host(`{{ domain | default('localhost') }}`)
      service: frontend
      priority: 1

    frontend-https:
      entryPoints:
        - websecure
      rule: Host(`{{ domain | default('localhost') }}`)
      service: frontend
      priority: 1
      tls:
        certResolver: letsencrypt

  middlewares:
    auth-headers:
      headers:
        customRequestHeaders:
          X-Auth-Service: "true"
        customResponseHeaders:
          X-API-Version: "1.0"
